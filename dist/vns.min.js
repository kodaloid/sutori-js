
class VnsChallengeEvent{constructor(owner,moment){this.Owner=owner;this.Moment=moment;this.ElementCount=moment.Elements.length;}
GetElements(culture,type){const elements=typeof culture=='undefined'?this.Moment.Elements.filter(e=>e instanceof type):this.Moment.Elements.filter(e=>e instanceof type&&(e.ContentCulture==culture||e.ContentCulture==VnsCulture.All));return elements;}
GetText(culture){return this.GetElements(culture,VnsElementText);}
GetOptions(culture){return this.GetElements(culture,VnsElementOption);}
GetImages(culture){return this.GetElements(culture,VnsElementImage);}
GetAudio(culture){return this.GetElements(culture,VnsElementAudio);}
GetVideos(culture){return this.GetElements(culture,VnsElementVideo);}}
class VnsDocument{constructor(){this.Moments=new Array();}
static async LoadXml(uri){const result=new VnsDocument();result.AddMomentsFromXmlUri(uri);return result;}
async AddMomentsFromXmlUri(uri){const response=await fetch(uri);const raw_xml=await response.text();await this.AddMomentsFromXml(raw_xml);}
async AddMomentsFromXml(raw_xml){const xml_parser=new DOMParser();const xml=xml_parser.parseFromString(raw_xml,"text/xml");const self=this;xml.querySelectorAll('moments moment').forEach((moment_e)=>{const moment=new VnsMoment();if(moment_e.hasAttribute('id')){moment.ID=moment_e.attributes['id'].textContent;}
if(moment_e.hasAttribute('goto')){moment.Goto=moment_e.attributes['goto'].textContent;}
moment_e.querySelectorAll('elements > *').forEach((element_e)=>{switch(element_e.tagName){case'text':moment.Elements.push(VnsElementText.Parse(element_e));break;case'option':moment.Elements.push(VnsElementOption.Parse(element_e));break;case'image':moment.Elements.push(VnsElementImage.Parse(element_e));break;case'audio':moment.Elements.push(VnsElementAudio.Parse(element_e));break;case'video':moment.Elements.push(VnsElementVideo.Parse(element_e));}});self.Moments.push(moment);});}
AddMoment(moment){this.Moments.push(moment);}}
class VnsElement{}
class VnsElementAudio extends VnsElement{constructor(){super();this.ContentCulture=VnsCulture.None;}
static Parse(element){const result=new VnsElementAudio();result.Src=element.textContent;if(element.hasAttribute('lang')){const lang=element.attributes['lang'].textContent;result.ContentCulture=VnsTools.ParseCulture(lang);}
return result;}}
class VnsElementImage extends VnsElement{constructor(){super();this.ContentCulture=VnsCulture.None;}
static Parse(element){const result=new VnsElementImage();result.Src=element.textContent;if(element.hasAttribute('lang')){const lang=element.attributes['lang'].textContent;result.ContentCulture=VnsTools.ParseCulture(lang);}
return result;}}
class VnsElementOption extends VnsElement{constructor(){super();this.ContentCulture=VnsCulture.None;this.Target=null;this.Solver=VnsSolver.None;this.SolverCallback=null;}
static Parse(element){const result=new VnsElementOption();result.Text=element.textContent;if(element.hasAttribute('lang')){const lang=element.attributes['lang'].textContent;result.ContentCulture=VnsTools.ParseCulture(lang);}
if(element.hasAttribute('target')){result.Target=element.attributes['target'].textContent;}
if(element.hasAttribute('solver')){const solver=element.attributes['solver'].textContent;result.Solver=VnsTools.ParseSolver(solver);}
if(element.hasAttribute('solver_callback')){result.Target=element.attributes['solver_callback'].textContent;}
return result;}}
class VnsElementText extends VnsElement{constructor(){super();this.ContentCulture=VnsCulture.None;}
static Parse(element){const result=new VnsElementText();result.Text=element.textContent;if(element.hasAttribute('lang')){const lang=element.attributes['lang'].textContent;result.ContentCulture=VnsTools.ParseCulture(lang);}
return result;}}
class VnsElementVideo extends VnsElement{constructor(){super();this.ContentCulture=VnsCulture.None;}
static Parse(element){const result=new VnsElementVideo();result.Src=element.textContent;if(element.hasAttribute('lang')){const lang=element.attributes['lang'].textContent;result.ContentCulture=VnsTools.ParseCulture(lang);}
return result;}}
class VnsEngine{constructor(document){this.Document=document;}
GotoMomentID(momentID){const moment=this.Document.Moments.find(t=>t.ID==momentID);if(moment==null)
throw new Error("Could not find moment with id #{momentID}.");this.GotoMoment(moment);}
GotoMoment(moment){if(moment==null)
moment=this.Document.Moments[0];if(moment==null)
throw new Error("Document does not have any beads!");this.Cursor=moment;this.HandleChallenge(new VnsChallengeEvent(this,moment));}
Play(){this.GotoMoment(null);}
GotoNextMoment(){if(this.Cursor==null)
return;const index=this.Document.Moments.indexOf(this.Cursor);if(index==-1)
return;if(this.Cursor.Goto!=''){this.GotoMomentID(this.Cursor.Goto);return;}
if(index==this.Document.Moments.length-1)
return;this.GotoMoment(this.Document.Moments[index+1]);}}
class VnsMoment{constructor(){this.Elements=new Array();this.ID='';this.Goto='';}
AddText(culture,text){const element=new VnsElementText();element.ContentCulture=culture;element.Text=text;this.Elements.push(element);return element;}
AddImage(culture,src){const element=new VnsElementImage();element.ContentCulture=culture;element.Src=src;this.Elements.push(element);return element;}
AddAudio(culture,src){const element=new VnsElementAudio();element.ContentCulture=culture;element.Src=src;this.Elements.push(element);return element;}
AddVideo(culture,src){const element=new VnsElementVideo();element.ContentCulture=culture;element.Src=src;this.Elements.push(element);return element;}
AddOption(culture,text,target){const element=new VnsElementOption();element.ContentCulture=culture;element.Text=text;element.Target=target;this.Elements.push(element);return element;}}
class VnsTools{static ParseCulture(cultureName){var _a;const stringKey=(_a=Object.entries(VnsCulture).find(([key,val])=>val===cultureName))===null||_a===void 0?void 0:_a[0];return VnsCulture[stringKey];}
static ParseSolver(solverName){var _a;const stringKey=(_a=Object.entries(VnsSolver).find(([key,val])=>val===solverName))===null||_a===void 0?void 0:_a[0];return VnsSolver[stringKey];}}
var VnsCulture;(function(VnsCulture){VnsCulture["None"]="none";VnsCulture["All"]="all";VnsCulture["EnUS"]="en-US";VnsCulture["zhCN"]="zh-CN";VnsCulture["ruRU"]="ru-RU";VnsCulture["FrFR"]="fr-FR";VnsCulture["esES"]="es-ES";VnsCulture["EnGB"]="en-GB";VnsCulture["deDE"]="de-DE";VnsCulture["ptBR"]="pt-BR";VnsCulture["enCA"]="en-CA";VnsCulture["esMX"]="es-MX";VnsCulture["itIT"]="it-IT";VnsCulture["jaJP"]="ja-JP";})(VnsCulture||(VnsCulture={}));var VnsSolver;(function(VnsSolver){VnsSolver["None"]="none";VnsSolver["OptionIndex"]="option_index";VnsSolver["KeyCharEquality"]="key_char_equality";VnsSolver["TextEquality"]="text_equality";VnsSolver["Custom"]="custom";})(VnsSolver||(VnsSolver={}));